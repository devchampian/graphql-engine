"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[7195],{3905:function(e,n,t){t.d(n,{Zo:function(){return u},kt:function(){return h}});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var s=a.createContext({}),c=function(e){var n=a.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},u=function(e){var n=c(e.components);return a.createElement(s.Provider,{value:n},e.children)},p={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(t),h=r,m=d["".concat(s,".").concat(h)]||d[h]||p[h]||i;return t?a.createElement(m,o(o({ref:n},u),{},{components:t})):a.createElement(m,o({ref:n},u))}));function h(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,o=new Array(i);o[0]=d;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=t[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},82175:function(e,n,t){t.r(n),t.d(n,{assets:function(){return u},contentTitle:function(){return s},default:function(){return h},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return p}});var a=t(83117),r=t(80102),i=(t(67294),t(3905)),o=["components"],l={description:"Query response caching in Hasura Cloud",keywords:["hasura","docs","cloud","response","caching"],sidebar_position:7},s="Query response caching",c={unversionedId:"graphql/cloud/response-caching",id:"graphql/cloud/response-caching",title:"Query response caching",description:"Query response caching in Hasura Cloud",source:"@site/docs/graphql/cloud/response-caching.mdx",sourceDirName:"graphql/cloud",slug:"/graphql/cloud/response-caching",permalink:"/docs/latest/graphql/cloud/response-caching",editUrl:"https://github.com/hasura/graphql-engine/edit/master/docs/docs/graphql/cloud/response-caching.mdx",tags:[],version:"current",sidebarPosition:7,frontMatter:{description:"Query response caching in Hasura Cloud",keywords:["hasura","docs","cloud","response","caching"],sidebar_position:7},sidebar:"cloudDocsSidebar",previous:{title:"Read replicas",permalink:"/docs/latest/graphql/cloud/read-replicas"},next:{title:"Distributed tracing",permalink:"/docs/latest/graphql/cloud/tracing"}},u={},p=[{value:"Introduction",id:"introduction",level:2},{value:"Enable caching",id:"enable-caching",level:2},{value:"Controlling cache lifetime",id:"controlling-cache-lifetime",level:2},{value:"Forcing the cache to refresh",id:"forcing-the-cache-to-refresh",level:2},{value:"Rate Limiting",id:"rate-limiting",level:2},{value:"Session variables",id:"session-variables",level:2},{value:"Response headers",id:"response-headers",level:2},{value:"Clearing items from the cache",id:"clearing-items-from-the-cache",level:2}],d={toc:p};function h(e){var n=e.components,t=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"query-response-caching"},"Query response caching"),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"Hasura Cloud provides support for caching query responses, in order to improve performance for queries which are executed frequently.\nThis includes actions and queries against remote schemas."),(0,i.kt)("p",null,"Cached responses are stored in for a period of time in a LRU (least-recently used) cache, and removed from the cache as needed based on usage."),(0,i.kt)("p",null,"A query's response can be cached only if the following conditions hold:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The query does ",(0,i.kt)("strong",{parentName:"li"},"not")," make use of ",(0,i.kt)("inlineCode",{parentName:"li"},"remote schemas")," that has ",(0,i.kt)("inlineCode",{parentName:"li"},"forward_client_headers")," (see ",(0,i.kt)("a",{parentName:"li",href:"/docs/latest/graphql/core/api-reference/syntax-defs#remoteschemadef"},"RemoteSchemaDef"),") set to ",(0,i.kt)("inlineCode",{parentName:"li"},"true"),"."),(0,i.kt)("li",{parentName:"ul"},"The query ",(0,i.kt)("strong",{parentName:"li"},"isn't")," an ",(0,i.kt)("inlineCode",{parentName:"li"},"Action")," that has ",(0,i.kt)("inlineCode",{parentName:"li"},"forward_client_headers")," (see ",(0,i.kt)("a",{parentName:"li",href:"/docs/latest/graphql/core/api-reference/syntax-defs#actiondefinition"},"ActionDefinition"),") set to ",(0,i.kt)("inlineCode",{parentName:"li"},"true"),"."),(0,i.kt)("li",{parentName:"ul"},"The response JSON is ",(0,i.kt)("strong",{parentName:"li"},"under")," 100KB in size")),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Support")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"Query response caching is available for Hasura Cloud projects on the ",(0,i.kt)("inlineCode",{parentName:"p"},"Free")," tier and above."))),(0,i.kt)("h2",{id:"enable-caching"},"Enable caching"),(0,i.kt)("p",null,"In order to enable caching for a query response, or to return an existing response from the cache (if one exists), simply add the ",(0,i.kt)("inlineCode",{parentName:"p"},"@cached")," directive to your query:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query MyCachedQuery @cached {\n  users {\n    id\n    name\n  }\n}\n")),(0,i.kt)("p",null,"If the response was cached successfully, the HTTP response will include a ",(0,i.kt)("inlineCode",{parentName:"p"},"Cache-Control")," header, whose value (",(0,i.kt)("inlineCode",{parentName:"p"},"max-age={SECONDS}"),") indicates the maximum number of seconds for the returned response to remain in the cache."),(0,i.kt)("h2",{id:"controlling-cache-lifetime"},"Controlling cache lifetime"),(0,i.kt)("p",null,"The maximum lifetime of an entry in the cache can be controlled using the ",(0,i.kt)("inlineCode",{parentName:"p"},"ttl")," argument to the ",(0,i.kt)("inlineCode",{parentName:"p"},"@cached")," query directive. The value is an integer number of seconds:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query MyCachedQuery @cached(ttl: 120) {\n  users {\n    id\n    name\n  }\n}\n")),(0,i.kt)("p",null,"By default, a response will be cached with a maximum lifetime of 60 seconds. The maximum allowed value is 300 seconds (5 minutes)."),(0,i.kt)("h2",{id:"forcing-the-cache-to-refresh"},"Forcing the cache to refresh"),(0,i.kt)("p",null,"The cache entry can be forced to refresh, regardless of the maximum lifetime using the ",(0,i.kt)("inlineCode",{parentName:"p"},"refresh")," argument to ",(0,i.kt)("inlineCode",{parentName:"p"},"@cached"),". The value is a boolean:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-graphql"},"query MyCachedQuery @cached(refresh: true) {\n  users {\n    id\n    name\n  }\n}\n")),(0,i.kt)("h2",{id:"rate-limiting"},"Rate Limiting"),(0,i.kt)("p",null,'Cache writes are rate limited, with a rate depending on your plan. The rate limit is based on the total number of bytes written to the cache in a sliding window. If you exceed the rate limit, the HTTP response will indicate this with a warning header: "Warning: 199 - cache-store-capacity-exceeded".'),(0,i.kt)("h2",{id:"session-variables"},"Session variables"),(0,i.kt)("p",null,"Queries using session variables are able to be cached."),(0,i.kt)("p",null,"Please note:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"A session variable will only influence the cache key for a query if it referenced by the execution plan. In practice this means that session variables are only factored into cache keys if they are referenced in the permissions for a query. See ",(0,i.kt)("a",{parentName:"li",href:"https://hasura.io/docs/latest/graphql/core/api-reference/schema-metadata-api/permission/"},"https://hasura.io/docs/latest/graphql/core/api-reference/schema-metadata-api/permission/"))),(0,i.kt)("h2",{id:"response-headers"},"Response headers"),(0,i.kt)("p",null,"When you enable caching for a query, the following headers should be returned in the HTTP response:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"X-Hasura-Query-Cache-Key")," - Key for cached query response, unique to this query"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"X-Hasura-Query-Family-Cache-Key")," - Key for the family of queries (ignores variable values)"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"Cache-Control")," - Value: ",(0,i.kt)("inlineCode",{parentName:"li"},"max-age={SECONDS}")," - Seconds until cache expires for query")),(0,i.kt)("p",null,"These can be used by your application as you see fit, as well as by the cache clearing endpoints."),(0,i.kt)("h2",{id:"clearing-items-from-the-cache"},"Clearing items from the cache"),(0,i.kt)("p",null,"A set of endpoints exist to clear items from the cache for the current project:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"POST /pro/cache/clear")," -- Clears all"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"POST /pro/cache/clear?key={HASH}")," -- Clears key hash"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"POST /pro/cache/clear?family={FAMILY}")," -- Clears items that match query family (ignoring variables)")))}h.isMDXComponent=!0}}]);