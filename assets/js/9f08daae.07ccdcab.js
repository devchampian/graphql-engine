"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6319],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return m}});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),p=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},c=function(e){var n=p(e.components);return a.createElement(o.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(t),m=r,h=d["".concat(o,".").concat(m)]||d[m]||u[m]||l;return t?a.createElement(h,i(i({ref:n},c),{},{components:t})):a.createElement(h,i({ref:n},c))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=d;var s={};for(var o in n)hasOwnProperty.call(n,o)&&(s[o]=n[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var p=2;p<l;p++)i[p]=t[p];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},70867:function(e,n,t){t.r(n),t.d(n,{assets:function(){return c},contentTitle:function(){return o},default:function(){return m},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return u}});var a=t(83117),r=t(80102),l=(t(67294),t(3905)),i=["components"],s={sidebar_label:"Run SQL",sidebar_position:1,description:"Execute SQL with the Hasura schema/metadata API",keywords:["hasura","docs","schema/metadata API","API reference","run_sql"]},o="Schema API Reference: Run SQL (v2.0 and above)",p={unversionedId:"graphql/core/api-reference/schema-api/run-sql",id:"graphql/core/api-reference/schema-api/run-sql",title:"Schema API Reference: Run SQL (v2.0 and above)",description:"Execute SQL with the Hasura schema/metadata API",source:"@site/docs/graphql/core/api-reference/schema-api/run-sql.mdx",sourceDirName:"graphql/core/api-reference/schema-api",slug:"/graphql/core/api-reference/schema-api/run-sql",permalink:"/graphql-engine/latest/graphql/core/api-reference/schema-api/run-sql",editUrl:"https://github.com/hasura/graphql-engine/edit/master/docs/docs/graphql/core/api-reference/schema-api/run-sql.mdx",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_label:"Run SQL",sidebar_position:1,description:"Execute SQL with the Hasura schema/metadata API",keywords:["hasura","docs","schema/metadata API","API reference","run_sql"]},sidebar:"docsSidebar",previous:{title:"Schema API Reference",permalink:"/graphql-engine/latest/graphql/core/api-reference/schema-api/index"},next:{title:"Metadata API Reference",permalink:"/graphql-engine/latest/graphql/core/api-reference/metadata-api/index"}},c={},u=[{value:"run_sql",id:"schema-run-sql",level:2},{value:"Use cases",id:"use-cases",level:3},{value:"Args syntax",id:"schema-run-sql-syntax",level:3},{value:"Response",id:"response",level:3},{value:"Some examples",id:"some-examples",level:3}],d={toc:u};function m(e){var n=e.components,t=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,a.Z)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("h1",{id:"schema-api-reference-run-sql-v20-and-above"},"Schema API Reference: Run SQL (v2.0 and above)"),(0,l.kt)("h2",{id:"schema-run-sql"},"run_sql"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"run_sql")," can be used to run arbitrary SQL statements."),(0,l.kt)("p",null,"Multiple SQL statements can be separated by a ",(0,l.kt)("inlineCode",{parentName:"p"},";"),", however, only the\nresult of the last SQL statement will be returned."),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Admin-only")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"This is an admin-only request, i.e. the request can only be executed\nwith ",(0,l.kt)("inlineCode",{parentName:"p"},"X-Hasura-Role: admin"),". This can be set by passing\n",(0,l.kt)("inlineCode",{parentName:"p"},"X-Hasura-Admin-Secret")," or by setting the right role in webhook/JWT\nauthorization mode."),(0,l.kt)("p",{parentName:"div"},"This is deliberate as it is hard to enforce any sort of permissions on\narbitrary SQL. If you find yourself in the need of using ",(0,l.kt)("inlineCode",{parentName:"p"},"run_sql")," to\nrun custom DML requests, consider creating a view. You can now define\npermissions on that particular view for various roles."))),(0,l.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"Supported from")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"The schema API is supported for versions ",(0,l.kt)("inlineCode",{parentName:"p"},"v2.0.0")," and above and replaces\nthe older ",(0,l.kt)("a",{parentName:"p",href:"/graphql-engine/latest/graphql/core/api-reference/schema-metadata-api/index"},"schema/metadata API"),"."))),(0,l.kt)("h3",{id:"use-cases"},"Use cases"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"To execute DDL operations that are not supported by the console\n(e.g. managing indexes)."),(0,l.kt)("li",{parentName:"ol"},"Run custom DML requests from backend microservices instead of\ninstalling libraries to speak to Postgres.")),(0,l.kt)("p",null,"An example:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'POST /v2/query HTTP/1.1\nContent-Type: application/json\nX-Hasura-Role: admin\n\n{\n    "type": "run_sql",\n    "args": {\n        "source": "default",\n        "sql": "CREATE UNIQUE INDEX ON films (title);"\n    }\n}\n')),(0,l.kt)("p",null,"While ",(0,l.kt)("inlineCode",{parentName:"p"},"run_sql")," lets you run any SQL, it tries to ensure that the Hasura\nGraphQL engine's state (relationships, permissions etc.) is consistent\ni.e. you cannot drop a column on which any metadata is dependent on (say\na permission or a relationship). The effects, however, can be cascaded."),(0,l.kt)("p",null,"Example: If we were to drop the 'bio' column from the author table\n(let's say the column is used in some permission), you would see an\nerror."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'POST /v2/query HTTP/1.1\nContent-Type: application/json\nX-Hasura-Role: admin\n\n{\n    "type": "run_sql",\n    "args": {\n        "source": "default",\n        "sql": "ALTER TABLE author DROP COLUMN name"\n    }\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'HTTP/1.1 400 BAD REQUEST\nContent-Type: application/json\n\n{\n    "path": "$.args",\n    "error": "cannot drop due to the following dependent objects : permission author.user.select"\n}\n')),(0,l.kt)("p",null,"We can however, cascade these changes."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http",metastring:"{9}","{9}":!0},'POST /v2/query HTTP/1.1\nContent-Type: application/json\nX-Hasura-Role: admin\n\n{\n    "type": "run_sql",\n    "args": {\n        "source": "default",\n        "sql": "ALTER TABLE author DROP COLUMN bio",\n        "cascade" : true\n    }\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'HTTP/1.1 200 OK\nContent-Type: application/json\n\n{\n    "result_type": "CommandOk"\n}\n')),(0,l.kt)("p",null,"With the above request, the dependent permission is also dropped."),(0,l.kt)("p",null,"Example: If we were to drop a foreign key constraint from the article\ntable (let's say the column involved in the foreign key is used to\ndefine a relationship), you would see an error."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'POST /v2/query HTTP/1.1\nContent-Type: application/json\nX-Hasura-Role: admin\n\n{\n    "type": "run_sql",\n    "args": {\n        "source": "default",\n        "sql": "ALTER TABLE article DROP CONSTRAINT article_author_id_fkey"\n    }\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'HTTP/1.1 400 BAD REQUEST\nContent-Type: application/json\n\n{\n    "path": "$.args",\n    "error": "cannot drop due to the following dependent objects : constraint article.article_author_id_fkey"\n}\n')),(0,l.kt)("p",null,"We can however, cascade these changes."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http",metastring:"{9}","{9}":!0},'POST /v2/query HTTP/1.1\nContent-Type: application/json\nX-Hasura-Role: admin\n\n{\n    "type": "run_sql",\n    "args": {\n        "source": "default",\n        "sql": "ALTER TABLE article DROP CONSTRAINT article_author_id_fkey",\n        "cascade" : true\n    }\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'HTTP/1.1 200 OK\nContent-Type: application/json\n\n{\n    "result_type": "CommandOk"\n}\n')),(0,l.kt)("p",null,"With the above request, the dependent permission is also dropped."),(0,l.kt)("p",null,"In general, the SQL operations that will affect Hasura metadata are:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Dropping columns"),(0,l.kt)("li",{parentName:"ol"},"Dropping tables"),(0,l.kt)("li",{parentName:"ol"},"Dropping foreign keys"),(0,l.kt)("li",{parentName:"ol"},"Altering types of columns"),(0,l.kt)("li",{parentName:"ol"},"Dropping SQL functions"),(0,l.kt)("li",{parentName:"ol"},"Overloading SQL functions")),(0,l.kt)("p",null,"In case of 1, 2 and 3 the dependent objects (if any) can be dropped\nusing ",(0,l.kt)("inlineCode",{parentName:"p"},"cascade"),". However, when altering type of columns, if any objects\nare affected, the change cannot be cascaded. So, those dependent objects\nhave to be manually dropped before executing the SQL statement. Dropping\nSQL functions will cascade the functions in metadata even without using\n",(0,l.kt)("inlineCode",{parentName:"p"},"cascade")," since no other objects depend on them. Overloading tracked SQL\nfunctions is not allowed."),(0,l.kt)("p",null,"Set ",(0,l.kt)("inlineCode",{parentName:"p"},"check_metadata_consistency")," field to ",(0,l.kt)("inlineCode",{parentName:"p"},"false")," to force the server to\nnot consider metadata dependencies."),(0,l.kt)("h3",{id:"schema-run-sql-syntax"},"Args syntax"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Key"),(0,l.kt)("th",{parentName:"tr",align:null},"Required"),(0,l.kt)("th",{parentName:"tr",align:null},"Schema"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"sql"),(0,l.kt)("td",{parentName:"tr",align:null},"true"),(0,l.kt)("td",{parentName:"tr",align:null},"String"),(0,l.kt)("td",{parentName:"tr",align:null},"The sql to be executed")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"source"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"String"),(0,l.kt)("td",{parentName:"tr",align:null},"The database on which the sql is to be executed (default: 'default' database)")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cascade"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,l.kt)("td",{parentName:"tr",align:null},"When set to ",(0,l.kt)("inlineCode",{parentName:"td"},"true"),", the effect (if possible) is cascaded to any hasuradb dependent objects (relationships, permissions, templates).")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"check_metadata_consistency"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,l.kt)("td",{parentName:"tr",align:null},"When set to ",(0,l.kt)("inlineCode",{parentName:"td"},"false"),", the sql is executed without checking metadata dependencies.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"read_only"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},"Boolean"),(0,l.kt)("td",{parentName:"tr",align:null},"When set to ",(0,l.kt)("inlineCode",{parentName:"td"},"true"),", the request will be run in ",(0,l.kt)("inlineCode",{parentName:"td"},"READ ONLY")," transaction access mode which means only ",(0,l.kt)("inlineCode",{parentName:"td"},"select")," queries will be successful. This flag ensures that the GraphQL schema is not modified and is hence highly performant.")))),(0,l.kt)("h3",{id:"response"},"Response"),(0,l.kt)("p",null,"The response is a JSON Object with the following structure."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Key"),(0,l.kt)("th",{parentName:"tr",align:null},"Always present"),(0,l.kt)("th",{parentName:"tr",align:null},"Schema"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"result_type"),(0,l.kt)("td",{parentName:"tr",align:null},"true"),(0,l.kt)("td",{parentName:"tr",align:null},"String"),(0,l.kt)("td",{parentName:"tr",align:null},'One of "CommandOk" or "TuplesOk"')),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"result"),(0,l.kt)("td",{parentName:"tr",align:null},"false"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"[[Text]]")," (An array of rows, each row an array of columns)"),(0,l.kt)("td",{parentName:"tr",align:null},"This is present only when the ",(0,l.kt)("inlineCode",{parentName:"td"},"result_type"),' is "TuplesOk"')))),(0,l.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,l.kt)("div",{parentName:"div",className:"admonition-heading"},(0,l.kt)("h5",{parentName:"div"},(0,l.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,l.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,l.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"Note")),(0,l.kt)("div",{parentName:"div",className:"admonition-content"},(0,l.kt)("p",{parentName:"div"},"The first row in the ",(0,l.kt)("inlineCode",{parentName:"p"},"result")," (when present) will be the names of the\ncolumns."))),(0,l.kt)("h3",{id:"some-examples"},"Some examples"),(0,l.kt)("p",null,"An SQL query returning results."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'POST /v2/query HTTP/1.1\nContent-Type: application/json\nX-Hasura-Role: admin\n\n{\n    "type": "run_sql",\n    "args": {\n        "source": "default",\n        "sql": "select user_id, first_name from author limit 2;"\n    }\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'HTTP/1.1 200 OK\nContent-Type: application/json\n\n{\n    "result_type": "TuplesOk",\n    "result": [\n        [\n            "user_id",\n            "first_name"\n        ],\n        [\n            "1",\n            "andre"\n        ],\n        [\n            "2",\n            "angela"\n        ]\n    ]\n}\n')),(0,l.kt)("p",null,"An SQL query to create a table:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'POST /v2/query HTTP/1.1\nContent-Type: application/json\nX-Hasura-Role: admin\n\n{\n  "type":"run_sql",\n  "args": {\n    "source": "default",\n    "sql": "create table item ( id serial,  name text,  category text,  primary key (id))",\n    "check_metadata_consistency": false\n  }\n}\n')),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-http"},'HTTP/1.1 200 OK\nContent-Type: application/json\n\n{\n  "result_type": "CommandOk",\n  "result": null\n}\n')))}m.isMDXComponent=!0}}]);